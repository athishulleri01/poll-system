{% extends 'base.html' %}

{% block title %}Results: {{ poll.question }} - Polling System{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-10">
        <div class="card shadow">
            <div class="card-header bg-success text-white">
                <div class="d-flex justify-content-between align-items-center">
                    <h4 class="mb-0"><i class="fas fa-chart-bar me-2"></i>Poll Results</h4>
                    <a href="{% url 'export_poll_results' poll.id %}" class="btn btn-light btn-sm">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </a>
                </div>
            </div>
            <div class="card-body">
                <h5 class="card-title">{{ poll.question }}</h5>
                
                {% if poll.is_expired %}
                    <div class="alert alert-warning">
                        <i class="fas fa-clock me-2"></i>This poll has expired and is no longer accepting votes.
                    </div>
                {% elif poll.expires_at %}
                    {% with time_remaining=poll.time_remaining %}
                        {% if time_remaining %}
                            <div class="alert alert-info">
                                <i class="fas fa-hourglass-half me-2"></i>
                                Time remaining: {{ time_remaining.days }} days, {{ time_remaining.hours }} hours, {{ time_remaining.minutes }} minutes
                            </div>
                        {% endif %}
                    {% endwith %}
                {% endif %}
                
                {% if poll.total_votes > 0 %}
                    <!-- Chart Section -->
                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="chart-container">
                                <canvas id="pollChart" width="400" height="400"></canvas>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="chart-container">
                                <canvas id="pollBarChart" width="400" height="400"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Detailed Results -->
                    <div class="mb-4">
                        <h6 class="fw-bold mb-3">Detailed Results</h6>
                        {% for option in poll.options.all %}
                            <div class="mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <span class="fw-bold">
                                        {{ option.text }}
                                        {% if user_vote and user_vote.option == option %}
                                            <i class="fas fa-check-circle text-success ms-2" title="Your vote"></i>
                                        {% endif %}
                                    </span>
                                    <span class="text-muted">
                                        {{ option.vote_count }} vote{{ option.vote_count|pluralize }}
                                        ({{ option.vote_percentage|floatformat:1 }}%)
                                    </span>
                                </div>
                                <div class="progress" style="height: 25px;">
                                    <div class="progress-bar {% if user_vote and user_vote.option == option %}bg-success{% else %}bg-primary{% endif %}" 
                                         role="progressbar" 
                                         style="width: {{ option.vote_percentage }}%" 
                                         aria-valuenow="{{ option.vote_percentage }}" 
                                         aria-valuemin="0" 
                                         aria-valuemax="100">
                                        {{ option.vote_percentage|floatformat:1 }}%
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                    
                    <!-- Statistics Summary -->
                    <div class="row text-center mb-4">
                        <div class="col-md-3">
                            <div class="stat-card">
                                <i class="fas fa-vote-yea fa-2x text-primary mb-2"></i>
                                <h4 class="text-primary">{{ poll.total_votes }}</h4>
                                <small class="text-muted">Total Votes</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <i class="fas fa-list fa-2x text-info mb-2"></i>
                                <h4 class="text-info">{{ poll.options.count }}</h4>
                                <small class="text-muted">Options</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <i class="fas fa-calendar fa-2x text-warning mb-2"></i>
                                <h4 class="text-warning">{{ poll.created_at|timesince }}</h4>
                                <small class="text-muted">Poll Age</small>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="stat-card">
                                <i class="fas fa-user fa-2x text-secondary mb-2"></i>
                                <h4 class="text-secondary">{{ poll.created_by.username }}</h4>
                                <small class="text-muted">Created By</small>
                            </div>
                        </div>
                    </div>
                {% else %}
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        No votes have been cast yet.
                    </div>
                {% endif %}
                
                <div class="d-flex gap-2">
                    <a href="{% url 'poll_list' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Polls
                    </a>
                    {% if user.is_authenticated and not user_vote and not poll.is_expired %}
                        <a href="{% url 'poll_detail' poll.id %}" class="btn btn-success">
                            <i class="fas fa-vote-yea me-2"></i>Vote Now
                        </a>
                    {% endif %}
                    {% if user.is_staff %}
                        <a href="{% url 'export_poll_results' poll.id %}" class="btn btn-outline-secondary">
                            <i class="fas fa-download me-2"></i>Export Results
                        </a>
                    {% endif %}
                </div>
            </div>
            <div class="card-footer text-muted">
                <div class="row">
                    <div class="col-md-6">
                        <i class="fas fa-calendar me-2"></i>Created: {{ poll.created_at|date:"M d, Y H:i" }}
                    </div>
                    <div class="col-md-6 text-end">
                        {% if poll.expires_at %}
                            <i class="fas fa-clock me-2"></i>
                            {% if poll.is_expired %}
                                Expired: {{ poll.expires_at|date:"M d, Y H:i" }}
                            {% else %}
                                Expires: {{ poll.expires_at|date:"M d, Y H:i" }}
                            {% endif %}
                        {% else %}
                            <i class="fas fa-infinity me-2"></i>No expiry date
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
<script>
// Fetch poll data and create charts
fetch('{% url "poll_results_json" poll.id %}')
    .then(response => response.json())
    .then(data => {
        const labels = data.options.map(option => option.text);
        const votes = data.options.map(option => option.votes);
        const percentages = data.options.map(option => option.percentage);
        
        // Color palette
        const colors = [
            '#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', 
            '#9966FF', '#FF9F40', '#FF6384', '#C9CBCF'
        ];
        
        // Pie Chart
        const pieCtx = document.getElementById('pollChart').getContext('2d');
        new Chart(pieCtx, {
            type: 'doughnut',
            data: {
                labels: labels,
                datasets: [{
                    data: votes,
                    backgroundColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderColor: '#fff'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Vote Distribution (Pie Chart)',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: {
                        position: 'bottom',
                        labels: {
                            padding: 15,
                            usePointStyle: true
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = percentages[context.dataIndex];
                                return context.label + ': ' + context.parsed + ' votes (' + percentage.toFixed(1) + '%)';
                            }
                        }
                    }
                }
            }
        });
        
        // Bar Chart
        const barCtx = document.getElementById('pollBarChart').getContext('2d');
        new Chart(barCtx, {
            type: 'bar',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Votes',
                    data: votes,
                    backgroundColor: colors.slice(0, labels.length).map(color => color + '80'),
                    borderColor: colors.slice(0, labels.length),
                    borderWidth: 2,
                    borderRadius: 8,
                    borderSkipped: false
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    title: {
                        display: true,
                        text: 'Vote Distribution (Bar Chart)',
                        font: { size: 16, weight: 'bold' }
                    },
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = percentages[context.dataIndex];
                                return context.label + ': ' + context.parsed.y + ' votes (' + percentage.toFixed(1) + '%)';
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            precision: 0,
                            stepSize: 1
                        },
                        title: {
                            display: true,
                            text: 'Number of Votes'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Options'
                        }
                    }
                }
            }
        });
    });

</script>

{% endblock content %}